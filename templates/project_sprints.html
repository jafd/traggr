{% extends "base.html" %}


{% block customjs %}

<script type="text/javascript" src={{ url_for('static', filename='files/js/jquery-1.11.0.min.js') }}></script>
<script type="text/javascript">

    $(document).ready(function() {

        window.removeResultsWithConfirmation = function(project, sprint) {

            $("#btnConfirmDeletion").click(function() {

                $("#li" +  sprint).remove();

                var url = "/_delete_results/" + project + "/" + sprint
                $.ajax({type: "DELETE", url: url});

            });
            $("#divBodyConfirmDeletion").text("Remove " + sprint + "?");

            $("#ModalConfirmDeletion").modal();

        };

        window.renameResults = function(project, sprint) {

            var link_tag = "<a href='/" + project + "/" + sprint +"'>" + sprint + "</a>"

            var results_locator = "#li" +  sprint;
            $(results_locator + " > a").remove();

            var input_id = "input" + sprint;
            var input_locator = "#" + input_id;
            if (!($(results_locator).has('input').length)) {
                $(results_locator).append("<input id='" + input_id + "' type='text'>");
                $(input_locator).val(sprint);
                $(input_locator).focus();

            };

            $(input_locator).focusout(function(event) {

                $(input_locator).remove();
                $(results_locator).append(link_tag);

            });

            $(input_locator).keypress(function(event) {

                if (event.keyCode === 13) {


                    var new_name = $(input_locator).val();

                    var url = "/_get_results_names/" + project;
                    var results_names = $.ajax({type: "GET", url: url, dataType: "json"});

                    if ( new_name.match(/^[a-zA-Z0-9_-]{1,60}$/) ) {

                        if ($.inArray(new_name, results_names) >= 0) {
                            alert(new_name + " exists");
                            return;
                        };

                        url = "/_rename_results/" + project + "/" + sprint + "/" + new_name;
                        $.ajax({type: "PUT", url: url});

                        $(input_locator).remove();
                        var new_link_tag = "<a href='/" + project + "/" + new_name +"'>" + new_name + "</a>"
                        $(results_locator).append(new_link_tag);

                    } else {
                        alert("New name is invalid");

                    };
                };

                if (event.keyCode === 27) {
                    $(input_locator).remove();
                    $(results_locator).append(link_tag);

                };

            });

        };

    });

</script>

{% endblock %}


{% block menu %}

        <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                {{ project }} <b class="caret"></b>
            </a>

            <ul class="dropdown-menu">

                {% for p in projects%}
                    <li><a href="/{{ p }}">{{ p }}</a></li>
                {% endfor %}

            </ul>
        </li>

        <li class="dropdown">

            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Results <b class="caret"></b>
            </a>

            <ul class="dropdown-menu">

                {% for s in sprints%}
                    <li><a href="/{{ project }}/{{ s }}">{{ s }}</a></li>
                {% endfor %}

            </ul>
        </li>

{% endblock %}


{% block body %}

        <div class="col-md-6">

            <ul class="list-group">

                {% for sprint in sprints %}
                    <li id="li{{ sprint }}" class="list-group-item">
                        <button style="display:none" type="button" class="btnRename btn btn-primary btn-xs" onclick='renameResults("{{ project }}", "{{ sprint }}")'>
                            <span class="glyphicon glyphicon-pencil pull-left"></span>
                        </button>&nbsp;

                        <button style="display:none" type="button" class="btnRemove btn btn-danger btn-xs" onclick='removeResultsWithConfirmation("{{ project }}", "{{ sprint }}")'>
                            <span class="glyphicon glyphicon-remove pull-left"></span>
                        </button>&nbsp;

                        <a href="/{{ project }}/{{ sprint }}">{{ sprint }}</a>
                    </li>
                {% endfor %}

            </ul>

        </div>

{% endblock %}